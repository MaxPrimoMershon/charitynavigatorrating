---
title: "CharityNavigatorRating"
author: "Max Mershon"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r pkgs, include = FALSE}
library(tidyverse)
library(ggplot2)
library(janitor)
library(broom)
library(caret)
library(plyr)
library(GGally)
library(car)
```


# Data Understanding

## Pull Data
```{r}
data = read.csv("../Charities_Data.csv")
str(data)
```

## Clean Numeric Variables
Count number of categorical occurences within each numeric variable.
```{r}
count(data, "Administrative.Expenses")
count(data, "Fundraising.Expenses")
count(data, "Fundraising.Efficiency")
count(data, "Working.Capital.Ratio..years.")
count(data, "Program.Expenses.Growth")
count(data, "Liabilities.to.Assets")
```

Replace categorical occurence with a `-1`.
```{r}
data_clean <- data %>%
  mutate(Administrative.Expenses = ifelse(Administrative.Expenses == "< 0.1%",-1, as.numeric(levels(data[,7])[data[,7]]))) %>%
  mutate(Fundraising.Expenses = ifelse(Fundraising.Expenses == "< 0.1%",-1, as.numeric(levels(data[,8])[data[,8]]))) %>%
  mutate(Fundraising.Efficiency = ifelse(Fundraising.Efficiency == "< $0.01",-1, as.numeric(levels(data[,9])[data[,9]]))) %>%
  mutate(Working.Capital.Ratio..years. = ifelse(Working.Capital.Ratio..years. == "< 0.01",-1, as.numeric(levels(data[,10])[data[,10]]))) %>%
  mutate(Program.Expenses.Growth   = ifelse(Program.Expenses.Growth   == "< 0.1%",-1, as.numeric(levels(data[,11])[data[,11]]))) %>%
  mutate(Liabilities.to.Assets = ifelse(Liabilities.to.Assets == "< 0.1%",-1, as.numeric(levels(data[,12])[data[,12]])))

head(data_clean)
```

Remove categorical occurences.
```{r}
data_clean <- data_clean %>%
  filter(Administrative.Expenses != -1) %>%
  filter(Fundraising.Expenses != -1) %>%
  filter(Fundraising.Efficiency != -1) %>%
  filter(Working.Capital.Ratio..years. != -1) %>%
  filter(Program.Expenses.Growth != -1) %>%
  filter(Liabilities.to.Assets != -1)

nrow(data_clean)
```


## Descriptive Statistics
```{r}
summary(select(data_clean, c(5:12)))
```

## Histograms of Numeric Variables
```{r}
for (i in colnames(select(data_clean, c(5:12)))){
  hist(data_clean[[i]], main = paste("Histogram of" , colnames(data_clean[i])))
}
```

## Frequency Charts of True/False Variables
```{r}
for (i in colnames(select(data_clean, c(13:29)))){
  print(ggplot(data_clean, aes(x = data_clean[[i]])) +
    geom_bar(stat = "count") + 
    xlab(colnames(data_clean[i])))
}
```

## Correlations amongst numeric variables
```{r}
ggpairs(select(data_clean, c(5:12)), progress = FALSE)
```

# Modeling

## Linear Regression
```{r}
reg <- lm(Overall.Rating ~ . - ID - Name - Link - EIN, data_clean)
summary(reg)
```

### Check Linear Regression Assumptions

(1) Linearity of Errors (Fitted vs. Residuals)
(2) Constant Variance of Errors (Fitted vs. Residuals)
```{r}
plot(reg)
```

(3) Collinearity (VIF)
```{r}
tidy(vif(reg))
```

(4) Outliers (Cook's Distance > .5)
```{r}
results <- augment(reg)

results %>%
  filter(.cooksd >= 0.5)
```

```{r}
data_clean<- data_clean %>%
  filter(!ID %in% c(1973, 3602, 7531))
```


## Regression #2
```{r}
reg <- lm(Overall.Rating ~ . - ID - Name - Link - EIN, data_clean)
summary(reg)
```

```{r}
plot(reg)
```


(5) Leverage Points (Hat > .04)
```{r}
results <- augment(reg)

leverage <- results %>%
  filter(.hat >= 0.04)

leverage$ID
```

```{r}
data_clean<- data_clean %>%
  filter(!ID %in% leverage$ID)
```

## Regression #3
```{r}
reg <- lm(Overall.Rating ~ . - ID - Name - Link - EIN, data_clean)
summary(reg)
```

```{r}
plot(reg)
```

### Large residuals
```{r}
results <- augment(reg)

largeresid <- results %>%
  filter(abs(.resid) >= 20)

largeresid$ID
```

```{r}
data_clean<- data_clean %>%
  filter(!ID %in% largeresid$ID)
```

## Regression #4
```{r}
reg <- lm(Overall.Rating ~ . - ID - Name - Link - EIN, data_clean)
summary(reg)
```

```{r}
plot(reg)
```

